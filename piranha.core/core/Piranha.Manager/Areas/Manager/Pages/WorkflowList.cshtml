@page "/manager/workflows"
@model Piranha.Manager.Models.WorkflowListModel
@inject ManagerLocalizer Localizer
@using Piranha.Manager
@{
    ViewBag.Title = "Editorial Workflows";
    ViewBag.MenuItem = "WorkflowList";
}

@section script
{
    <script>
        piranha.workflow = {};

        piranha.workflow.load = function () {
            fetch(piranha.baseUrl + 'api/workflow/definitions')
                .then(function (response) { return response.json(); })
                .then(function (result) {
                    piranha.workflow.updateList(result);
                })
                .catch(function (error) {
                    console.error('Error loading workflows:', error);
                });
        };

        piranha.workflow.updateList = function (workflows) {
            var html = '';
            for (var i = 0; i < workflows.length; i++) {
                var workflow = workflows[i];
                html += '<div class="card">';
                html += '<div class="card-body">';
                html += '<div class="row">';
                html += '<div class="col">';
                html += '<h5 class="card-title">' + workflow.name + '</h5>';
                html += '<p class="card-text text-muted">' + (workflow.description || '') + '</p>';
                html += '<small class="text-muted">States: ' + (workflow.states ? workflow.states.length : 0) + '</small>';
                html += '</div>';
                html += '<div class="col-auto">';
                html += '<div class="btn-group" role="group">';
                html += '<button type="button" class="btn btn-primary btn-sm" onclick="piranha.workflow.edit(\'' + workflow.id + '\')">Edit</button>';
                html += '<button type="button" class="btn btn-outline-secondary btn-sm" onclick="piranha.workflow.configure(\'' + workflow.id + '\')">Configure States</button>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            if (workflows.length === 0) {
                html = '<div class="empty"><div class="empty-icon"><i class="fas fa-project-diagram"></i></div><p class="empty-title h5">No workflows</p><p class="empty-subtitle text-muted">You haven\'t created any editorial workflows yet.</p></div>';
            }

            document.getElementById('workflow-list').innerHTML = html;
        };

        piranha.workflow.create = function () {
            piranha.workflow.openModal();
        };

        piranha.workflow.edit = function (id) {
            fetch(piranha.baseUrl + 'api/workflow/definitions/' + id)
                .then(function (response) { return response.json(); })
                .then(function (workflow) {
                    piranha.workflow.openModal(workflow);
                })
                .catch(function (error) {
                    console.error('Error loading workflow:', error);
                });
        };

        piranha.workflow.openModal = function (workflow) {
            workflow = workflow || { name: '', description: '', isActive: true };
            
            document.getElementById('workflow-modal-title').textContent = workflow.id ? 'Edit Workflow' : 'Create Workflow';
            document.getElementById('workflow-name').value = workflow.name || '';
            document.getElementById('workflow-description').value = workflow.description || '';
            document.getElementById('workflow-active').checked = workflow.isActive !== false;
            document.getElementById('workflow-modal').setAttribute('data-workflow-id', workflow.id || '');
            
            var modal = new bootstrap.Modal(document.getElementById('workflow-modal'));
            modal.show();
        };

        piranha.workflow.save = function () {
            var workflowId = document.getElementById('workflow-modal').getAttribute('data-workflow-id');
            var isEdit = workflowId && workflowId !== '';
            
            var workflow = {
                name: document.getElementById('workflow-name').value,
                description: document.getElementById('workflow-description').value,
                isActive: document.getElementById('workflow-active').checked
            };
            
            if (isEdit) {
                workflow.id = workflowId;
            }

            var url = piranha.baseUrl + 'api/workflow/definitions' + (isEdit ? '/' + workflowId : '');
            var method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(workflow)
            })
            .then(function (response) {
                if (response.ok) {
                    var modal = bootstrap.Modal.getInstance(document.getElementById('workflow-modal'));
                    modal.hide();
                    piranha.workflow.load();
                } else {
                    console.error('Error saving workflow');
                }
            })
            .catch(function (error) {
                console.error('Error saving workflow:', error);
            });
        };

        piranha.workflow.configure = function (id) {
            window.location.href = piranha.baseUrl + 'manager/workflow/' + id + '/states';
        };

        // Load workflows on page ready
        document.addEventListener('DOMContentLoaded', function() {
            piranha.workflow.load();
        });
    </script>
}

<div class="top">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">@Localizer.Menu["System"]</li>
            <li class="breadcrumb-item active" aria-current="page">Editorial Workflows</li>
        </ol>
    </nav>

    <div class="container-fluid app" id="workflow-list-app">
        <div class="top-nav">
            <button class="btn btn-primary btn-labeled" type="button" onclick="piranha.workflow.create()">
                <i class="fas fa-plus"></i>Create Workflow
            </button>
        </div>
    </div>
</div>

<div class="container-fluid app">
    <div id="workflow-list">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
                <div class="card load-indicator">
                    <div class="card-body text-center">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Modal -->
<div class="modal fade" id="workflow-modal" tabindex="-1" aria-labelledby="workflow-modal-title" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="workflow-modal-title">Create Workflow</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="workflow-name" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="workflow-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="workflow-description" class="form-label">Description</label>
                        <textarea class="form-control" id="workflow-description" rows="3"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="workflow-active" checked>
                        <label class="form-check-label" for="workflow-active">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="piranha.workflow.save()">Save</button>
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()
